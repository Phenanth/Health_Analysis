# README

## Git使用

`git log`
`git reset [id]`回退，遇到不想要的本地cache时，最好回退到`origin/master`

## List数据入库

> 已完成

数据项比较统一，好操作。

## Abnormal数据入库

> 已完成

因为数据项比较统一，这个过程应该也会比较快

但是有个疑问，诊断内容（match_name）五花八门，需要做整理吗？

还有个现象，有些数据的Id是`'7a9fbdd153b84fd39fdf9b7e082616bc'`这种类似于reportId长度的数据(只有三条)，和其他的六位编号`'C30080', `形式不同。

## Template数据入库

> 已完成

数据项比较统一，处理起来应该不难
把缺少的`minValue`和`maxValue`的数值也给添加上去了

## Report数据入库
重头戏，数据项很不统一
需要将不同的名称映射到一个标准名上
其次再按照一个标准的数据结构将每个JSON导入到相应表中

### 数据库表设计

#### Index表设计

统计了一下所有文件的key，发现同样的数值有很多不同的名称，需要建立index表来对不同数值统一命名。

key一览（以常规检查为例）：
```bash
['脉搏', '体重', '身高', '复测血压(收缩压)', '体重指数', '复测血压(舒张压)', '体检血压(收缩压)', '体检血压(舒张压)', 'reportId', 'clientId', '舒张压', '收缩压', '复测血压2(舒张压)', '复测血压2(收缩压)', '腰围(男)', '臀围', '臀围(男)', '腰臀比'...]
```

重复内容（简略）：
搜简写能够找到很多重复的值
```bash
['血小板容积分布宽度（PDW）',
 '血小板比容（PCT）', # 这个
 '血小板(PLT)', # 这个
 '血红蛋白(Hb)',
 '血小板容积分布宽度[PDW]',
 '血小板计数(PLT)', # 这个
 '红细胞压积[HCT]',
 '血小板压积[PCT]', # 这个
 '中性粒细胞百分比[N]',
 '中性粒细胞绝对值（GRA#）'],
 ...
```

Index的设计过程又写了个脚本文件，因为想着手工比对既存分类实在是太泯灭人性了...
参考`/Health_Analysis/scripts/programm_mannual_classifier.py`

效果预览`index_tumour.json`:
```JSON
{
    "indexs": [
        "癌胚抗原CEA(发光)",
        "甲胎蛋白AFP(发光)",
        "糖类抗原125(CA125)(发光)",
        "游离前列腺特异性抗原（F-PSA）",
        "糖类抗原19-9(CA19-9)",
        "总前列腺特异性抗原（T-PSA）",
        "F-PSA/T-PSA",
        "糖类抗原15-3(CA15-3)",
        "细胞角蛋白19片段(Cyfra 21-1)",
        "鳞状细胞相关抗原(SCC)",
        "糖类抗原242",
        "糖类抗原72-4(CA72-4)",
        "铁蛋白(FER)",
        "胃泌素-17",
        "胃蛋白酶原I/胃蛋白酶原II测定",
        "胃蛋白酶原I[PGI]",
        "胃蛋白酶原II[PGII]",
        ...
    ],
    "mapping": [
        {
            "reportName": "癌胚抗原CEA(发光)",
            "scientificName": "癌胚抗原CEA(发光)"
        },
        {
            "reportName": "甲胎蛋白AFP(发光)",
            "scientificName": "甲胎蛋白AFP(发光)"
        },
        {
            "reportName": "糖类抗原125(CA125)(发光)",
            "scientificName": "糖类抗原125(CA125)(发光)"
        },
        ...
    ]
}
```

关于胰岛素抗体那里真的把我这个人工分类的人搞蒙了，跑去查了资料：
胰岛素抗体INS-Ab可以分成
- 抗胰岛素细胞抗体ICA/IA
- 抗胰岛素自身抗体IAA

个人分类完成之后总共有178个不同的列
> 还不知道分类在医学上是否准确...
> 我和谷歌已经尽力了
> 想把scientificName统一改成小括号，然后GG了，全部都改掉了（不要手滑

还需要做统一英文命名，这个就还是人工做吧（

设计完了index，相当于已经把表列简化工作做完了，就需要实打实地设计表列了
应该可以通过脚本便捷化处理，通过表修改的方式将不重复的列名添加进去。
*注意：index表内处于一个genre下的数据是属于同一个表的*

SQL区别
- 汉字
- 为空
- 尾部s/°等特殊符号
- 数字

### Report_[genre]表的设计

> 未开始

### 入库

初步构想的入库的流程：
1. 查询该json对应的表，新建该对应表的标准数据结构
2. 在index表中查询当前json所有数据项对应的标准名
3. 在当前数据结构中添加对应标准名的数据项
4. 对于不存在的数据列，在数据结构中将其赋值为空

#### 数据库表修正语句

修改字段长度：
`alter table report_thyroid modify column THY_Detail varchar(400);`

修改表编码：
`alter table report_blood character set utf8;`

修改列编码：
`alter table report_heart modify column ECG varchar(10) character set utf8mb4 collate utf8mb4_unicode_ci;`

#### report_heart

由于该数据原本就并不标准，舍弃：
```bash
Data too long: ('c1278fe404334da1b53fc1bb37dea474', 'ac8d34b395b54720a04cd50b84718345', '0', '0', '0', '0', '0', '0', ' 窦性心律\n***正常心电图***', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0')
```

#### list_static

标准数据的入库，目前还在设计各个表标准化的算法
基本的做法就是通过找到标准名对应的标准范围，处理相关的范围值使其变成表示范围的两个数字，以便后续使用
目前的产出物是一个存放找到标准名匹配的数据在数据对象内位置的JSON，后续工作将基于该JSON展开，通过JSON存放的position，对该数据项内数据进行标准化处理，并通过SQL语句将标准化后的数据存入数据库。

```
{'CEA': [0, '癌胚抗原CEA(发光)'], 'AFP': [0, '甲胎蛋白AFP(发光)'], 'CA125': [0, '糖类抗原125(CA125)(发光)'], 'F_PSA': [3, '游离前列腺特异性抗原（F-PSA）'], 'CA199': [3, '糖类抗原19-9(CA19-9)'], 'T_PSA': [3, '总前列腺特异性抗原（T-PSA）'], 'F_PSAdevT_PSA': [3, 'F-PSA/T-PSA'], 'CA153': [7, '糖类抗原15-3(CA15-3)'], 'CYF211': [47, '细胞角蛋白19片段(Cyfra 21-1)'], 'SCC': [47, '鳞状细胞相关抗原(SCC)'], 'CA242': [47, '糖类抗原242'], 'CA724': [50, '糖类抗原72-4(CA72-4)'], 'FER': [50, '铁蛋白(FER)'], 'G17': [227, '胃泌素-17'], 'PGII': [227, '胃蛋白酶原II测定'], 'PGI': [227, '胃蛋白酶原I测定'], 'PGIdevPGII': [227, '胃蛋白酶原I/胃蛋白酶原II测定'], 'CA50': [298, '糖类抗原50(CA50)'], 'NSE': [300, '神经元特异性烯醇化酶(NSE)'], 'PSA': [427, '前列腺特异性抗原'], 'TSGF': [427, '恶性肿瘤特异性生长因子'], 'TNF': [427, '肿瘤坏死因子'], 'IFN': [427, '干扰素'], 'ECS': [427, '早期肿瘤筛查(液态芯片)'], 'AFP_R': [427, '甲胎蛋白(AFP)(定性)'], 'CEA_R': [427, '癌胚抗原(CEA)(定性)'], 'AFU': [951, '血清α-L-岩藻糖苷酶'], 'ProGRP': [1783, '胃泌素释放钛前体[ProGRP]'], 'b_HCG': [5069, '血清人绒毛膜促性腺激素(β-HCG）'], 'CT': [14585, '降钙素(CT)'], 'FIO': [16104, '血清铁离子'], 'UIBC': [21787, '不饱和铁结合能力(UIBC)'], 'NMP22': [23072, '膀胱瘤（NMP22）'], 'HE4': [24627, '附睾蛋白4'], 'EB_IgM': [47895, 'EB病毒抗体IgM']}
```

完成了，大概就是这个感觉：
- 如果min和max都为0，就检查property的值
- property如果也是null，就是不存在范围
- 如果property有值，则参考判断结果是property字符串内数据

```SQL
mysql> select * from list_static where genre="tumour";
+----------------+-----------+------------+--------+----------+
| scientificName | minValue  | maxValue   | genre  | property |
+----------------+-----------+------------+--------+----------+
| CEA            |  0.000000 |   5.000000 | tumour | NULL     |
| AFP            |  0.000000 |  10.000000 | tumour | NULL     |
| CA125          |  0.000000 |  35.000000 | tumour | NULL     |
| F_PSA          |  0.000000 |   0.930000 | tumour | NULL     |
...
| UIBC           | 25.000000 |  50.100000 | tumour | NULL     |
| HE4            |  0.000000 |  70.000000 | tumour | NULL     |
| ECS            |  0.000000 |   0.000000 | tumour | 未见异常 |
| AFP_R          |  0.000000 |   0.000000 | tumour | 阴性     |
| CEA_R          |  0.000000 |   0.000000 | tumour | 阴性     |
| NMP22          |  0.000000 |   0.000000 | tumour | 阴性     |
| EB_IgM         |  0.000000 |   0.000000 | tumour | 阴性     |
+----------------+-----------+------------+--------+----------+
```

> 顺便发现好像report的数据并不是都存进数据库了，估计是因为通过非标准名查找的时候没有对genre做限制，导致返回的结果内有不唯一的scientificName，有需要重新导入数据的可能。
> 

### 数据汇总

在对每个表入库后，需要将同一个病人的报告信息汇总到一张总表上
总表将概括不仅包括所有report数据项的内容，还应该包括一个abnormal字段。
> abnormal为6字符长度的字符串，每一位表示一个检查分类下的异常项数


#### 单表统计

写拥有以下数据流处理的SQL语句：
1. 对于report_[genre]表内每条数据遍历以下内容
2. 首先根据本表的genre与scientificName找到对应的minValue与maxValue
3. 找到了则计算report对应列的值是否在min和max的范围内，不在则为异常
4. 若没找到（两个值都为0的情况），查看列内容与property字段值是否相等
5. 相等则无异常，不相等则有异常
6. 统计异常数并修改该记录的numAbnormal为异常数值

初步工作完成了，需要检查各项统计是否准确。

目前在general表统计中发现可能会有问题的情况：
因为存在复查，再复查的情况，所以最多可能会有七个异常项目，但是这样的异常项目实际上并不是实实在在的高危，总得来说只能算是三个（BMI、DBP、SBP）

> 翌日思考：但是在模型判断的角度来说，只要提供字段和最后的结果有所匹配即可
> 并不需要担心实际上是否有意义这件事

另外Thyroid表如何统计还是个尚未解决的问题

> 0508开会记录本部分相关：
> thyroid的异常数可以不用管
> 单位异常超过10的用阿拉伯字母表示

重新检查了一遍list_static的值，把没有范围的值重新填充了一下
真的不存在范围的情况如下：
- Blood
 LCR            | 0.000000 | 0.000000 | blood | NULL
去网上虽然能查到值，但是大部分患者的测试结果都不在正常值范围以内，所以还是不计入考虑范围

- Chemical
ASTdevALT      | 0.000000 |   0.000000 | chemical | NULL
来自4ef7b611ca0046b0b33acaa3a8837678的报告，查到了3.9-6.1不知是否可信
选择相信百度0.8-1.5

- General
身高体重这种没有办法列举范围
臀围以及臀围男臀围女不同："标准臀围=身高×0.542"，这里暂时简化不提
> 另外可能存在因为一开始将男女分别的列为一个分类，导致正常范围不同的问题，如果影响到后续的测试的话这里也是一个优化点

- Heart
> 这个表的数据比其他的少很多，可能会有需要重新导入的需要

心电图没有意义，因为正常的需要从很多间期获得
窦性心律这一条也没有意义，因为都是字符串的判断结果
其他还有很多没有意义的字段...不列举了

- Tumour
没有不存在范围的字段

在调整完了range后，同时也统计了各个异常数的记录数，统计结果见`static_report.sql`
统计结果可以在创造训练数据的标记时，作为设置阈值的参考而使用。

> 0519又稍微做了一下数值的统计
> 有一件想了之后觉得有点担心的事情，chemical异常数值非常高的例子里面，标准和`list_static`表里存的数据有一定的出入...
> 不过还是决定先继续做总表汇总，在模型训练遇到问题的时候再回来看看好了。

#### 总表汇总

> 这一个阶段的工作量很小，因为前面的步骤把数据都处理得很标准了，只需要把每一个表的列合在一起，再将每个表的标记字段也按位组合即可。

暂时规定为以下顺序：
1. 第一位：blood
2. 第二位：chemical
3. 第三位：general
4. 第四位：heart
5. 第五位：thyroid
6. 第六位：tumour

每一位的范围按照十六进制记录，示例：`000000`，`FFFFFF`

异常情况：
- numAbnormal是NULL（我也不知道为什么会这样）
- numAbnormal大于15（异常数据，需要把整个report扔掉）

## 模型训练

模型训练源标记为`000000`的标记，每一分类的初始阈值都是1，如果单位置上大于0则有异常
后期需要优化模型时，则需要找到每个位上能够使预测结果达到最佳的阈值
> 感觉这里的最佳阈值也要靠python工具遍历最佳的位数。
> 简单算法：
> 1. 寻找每一位最佳的阈值，从高到低排序
> 2. 从每一位的预判效果最好的阈值开始遍历，寻找下一位搭配最佳的阈值
> 3. 更换每一位训练开始的搭配，统计预测概率最高的阈值搭配
> 
> 虽然感觉这样效率很低不说...把每个表的异常合在一起的意义好像也消失了（
> 不过先这样吧。

